<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockPilot AI - AI ìì‚°ê´€ë¦¬ íŒŒíŠ¸ë„ˆ</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #0a0e27; 
            color: #ffffff; 
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        /* í—¤ë” */
        .header { 
            padding: 20px;
            background: rgba(255,255,255,0.03);
            border-bottom: 1px solid rgba(255,255,255,0.08);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        .header h1 { 
            font-size: 24px; 
            font-weight: 700;
            background: linear-gradient(90deg, #00d4ff, #0099ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* í˜ì´ì§€ ì»¨í…Œì´ë„ˆ */
        .page {
            display: none;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* í¬íŠ¸í´ë¦¬ì˜¤ ì¹´ë“œ */
        .portfolio-card { 
            background: linear-gradient(135deg, rgba(0,150,255,0.15), rgba(0,200,255,0.08));
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            border: 1px solid rgba(0,150,255,0.2);
        }
        
        .portfolio-label {
            font-size: 14px;
            color: #8B95A1;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .portfolio-value { 
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 12px;
            letter-spacing: -1px;
        }
        
        .profit-info {
            display: flex;
            align-items: baseline;
            gap: 12px;
        }
        
        .positive { color: #00ff88; }
        .negative { color: #ff4757; }
        
        /* ìƒíƒœ ì¹´ë“œ */
        .status-card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        
        .status-icon {
            font-size: 24px;
        }
        
        .status-text {
            font-size: 18px;
            font-weight: 600;
        }
        
        /* AI ì¶”ì²œ ì¹´ë“œ */
        .action-grid { 
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .action-card { 
            background: rgba(255,255,255,0.04);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.08);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .action-card:hover { 
            transform: translateY(-2px);
            background: rgba(255,255,255,0.06);
        }
        
        .action-card.danger { 
            border-left: 3px solid #ff4757;
            background: linear-gradient(90deg, rgba(255,71,87,0.1), transparent);
        }
        
        .action-card.opportunity { 
            border-left: 3px solid #00ff88;
            background: linear-gradient(90deg, rgba(0,255,136,0.1), transparent);
        }
        
        .action-title { 
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .detail-box { 
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            font-size: 15px;
            line-height: 1.6;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .detail-row:last-child {
            margin-bottom: 0;
        }
        
        .detail-label {
            color: #8B95A1;
        }
        
        .detail-value {
            font-weight: 600;
        }
        
        /* ì•¡ì…˜ ë²„íŠ¼ */
        .action-button { 
            width: 100%;
            padding: 14px;
            background: linear-gradient(90deg, #0099ff, #00d4ff);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .action-button:active {
            transform: scale(0.98);
        }
        
        /* ì¢…ëª© ë¦¬ìŠ¤íŠ¸ */
        .stock-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .stock-card {
            background: rgba(255,255,255,0.04);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.08);
            transition: all 0.2s;
        }
        
        .stock-card:hover {
            background: rgba(255,255,255,0.06);
        }
        
        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }
        
        .stock-name {
            font-size: 18px;
            font-weight: 600;
        }
        
        .stock-quantity {
            font-size: 14px;
            color: #8B95A1;
        }
        
        .stock-current {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .stock-profit {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        
        /* ê±°ë˜ ê¸°ë¡ */
        .history-item {
            background: rgba(255,255,255,0.04);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        
        .history-date {
            font-size: 12px;
            color: #8B95A1;
            margin-bottom: 8px;
        }
        
        .history-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-stock {
            font-size: 16px;
            font-weight: 600;
        }
        
        .history-profit {
            font-size: 16px;
            font-weight: 700;
        }
        
        /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            height: 65px;
            z-index: 1000;
        }
        
        .nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            background: none;
            border: none;
            color: #8B95A1;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .nav-btn.active {
            color: #00d4ff;
        }
        
        .nav-btn:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .nav-icon {
            font-size: 20px;
        }
        
        /* ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: #1a1f3a;
            border-radius: 20px;
            padding: 24px;
            width: 100%;
            max-width: 400px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .modal-header {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
        }
        
        .input-group {
            margin-bottom: 16px;
        }
        
        .input-label {
            font-size: 14px;
            color: #8B95A1;
            margin-bottom: 8px;
        }
        
        input {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            font-size: 16px;
            color: white;
        }
        
        input:focus {
            outline: none;
            border-color: #00d4ff;
            background: rgba(255,255,255,0.08);
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-cancel {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .btn-confirm {
            background: linear-gradient(90deg, #0099ff, #00d4ff);
            color: white;
        }
        
        /* í—¤ë” ë²„íŠ¼ */
        .header-buttons {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 10px;
        }
        
        .header-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .header-btn:hover {
            background: rgba(255,255,255,0.15);
        }
    </style>
</head>
<body>

<!-- í—¤ë” -->
<div class="header">
    <h1>StockPilot AI</h1>
    <div class="header-buttons">
        <button class="header-btn" onclick="openBuyModal()">ë§¤ìˆ˜</button>
        <button class="header-btn" onclick="openSellModal()">ë§¤ë„</button>
    </div>
</div>

<!-- í™ˆ í˜ì´ì§€ -->
<div id="home" class="page active">
    <div class="portfolio-card">
        <div class="portfolio-label">ì´ ìì‚°</div>
        <div class="portfolio-value" id="total-asset">â‚©0</div>
        <div class="profit-info">
            <span class="profit-amount positive" id="profit-amount">+â‚©0</span>
            <span class="profit-rate positive" id="profit-rate">+0.00%</span>
            <span style="color: #8B95A1">ì˜¤ëŠ˜</span>
        </div>
    </div>
    
    <div class="status-card">
        <div class="status-icon" id="status-icon">âœ…</div>
        <div class="status-text" id="status-text">í¬íŠ¸í´ë¦¬ì˜¤ ì•ˆì •</div>
    </div>
    
    <!-- AI ì¶”ì²œ ì¹´ë“œë“¤ -->
    <div class="action-grid" id="ai-recommendations">
        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
    </div>
</div>

<!-- í¬íŠ¸í´ë¦¬ì˜¤ í˜ì´ì§€ -->
<div id="portfolio" class="page">
    <div class="stock-list" id="stock-list">
        <!-- ì¢…ëª© ì¹´ë“œ ë™ì  ìƒì„± -->
    </div>
</div>

<!-- ê¸°ë¡ í˜ì´ì§€ -->
<div id="history" class="page">
    <div class="portfolio-card">
        <div class="portfolio-label">ëˆ„ì  ìˆ˜ìµ</div>
        <div class="portfolio-value positive" id="total-profit">+â‚©0</div>
    </div>
    
    <div id="history-list">
        <!-- ê±°ë˜ ê¸°ë¡ ë™ì  ìƒì„± -->
    </div>
</div>

<!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
<nav class="bottom-nav">
    <button class="nav-btn active" onclick="showPage('home')">
        <span class="nav-icon">ğŸ </span>
        <span>í™ˆ</span>
    </button>
    <button class="nav-btn" onclick="showPage('portfolio')">
        <span class="nav-icon">ğŸ“Š</span>
        <span>í¬íŠ¸í´ë¦¬ì˜¤</span>
    </button>
    <button class="nav-btn" onclick="showPage('history')">
        <span class="nav-icon">ğŸ“</span>
        <span>ê¸°ë¡</span>
    </button>
</nav>

<!-- ë§¤ìˆ˜ ëª¨ë‹¬ -->
<div id="buy-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">ë§¤ìˆ˜ ê¸°ë¡</div>
        <div class="input-group">
            <div class="input-label">ì¢…ëª©ëª…</div>
            <input type="text" id="buy-stock-name" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì">
        </div>
        <div class="input-group">
            <div class="input-label">ìˆ˜ëŸ‰</div>
            <input type="number" id="buy-quantity" placeholder="ì˜ˆ: 10">
        </div>
        <div class="input-group">
            <div class="input-label">ë§¤ìˆ˜ê°€</div>
            <input type="number" id="buy-price" placeholder="ì˜ˆ: 68500">
        </div>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeBuyModal()">ì·¨ì†Œ</button>
            <button class="btn-confirm" onclick="confirmBuy()">í™•ì¸</button>
        </div>
    </div>
</div>

<!-- ë§¤ë„ ëª¨ë‹¬ -->
<div id="sell-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">ë§¤ë„ ê¸°ë¡</div>
        <div class="input-group">
            <div class="input-label">ì¢…ëª©ëª…</div>
            <input type="text" id="sell-stock-name" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì">
        </div>
        <div class="input-group">
            <div class="input-label">ìˆ˜ëŸ‰</div>
            <input type="number" id="sell-quantity" placeholder="ì˜ˆ: 5">
        </div>
        <div class="input-group">
            <div class="input-label">ë§¤ë„ê°€</div>
            <input type="number" id="sell-price" placeholder="ì˜ˆ: 72000">
        </div>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeSellModal()">ì·¨ì†Œ</button>
            <button class="btn-confirm" onclick="confirmSell()">í™•ì¸</button>
        </div>
    </div>
</div>

<script>
// ë°ì´í„° ì €ì¥ì†Œ
let portfolio = JSON.parse(localStorage.getItem('portfolio') || '[]');
let history = JSON.parse(localStorage.getItem('history') || '[]');
let totalAsset = 0;
let totalProfit = 0;

// MCP API ì„¤ì • (ë¡œì»¬ ê°œë°œìš©)
const API_URL = window.location.hostname === 'localhost' ? 'http://localhost:8001' : '';

// í˜ì´ì§€ ì „í™˜
function showPage(pageName) {
    // ëª¨ë“  í˜ì´ì§€ ìˆ¨ê¹€
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    
    // ëª¨ë“  ë„¤ë¹„ ë²„íŠ¼ ë¹„í™œì„±í™”
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // ì„ íƒëœ í˜ì´ì§€ í‘œì‹œ
    document.getElementById(pageName).classList.add('active');
    
    // ì„ íƒëœ ë„¤ë¹„ ë²„íŠ¼ í™œì„±í™”
    event.target.closest('.nav-btn').classList.add('active');
    
    // í˜ì´ì§€ë³„ ë°ì´í„° ì—…ë°ì´íŠ¸
    if (pageName === 'home') {
        updateHome();
    } else if (pageName === 'portfolio') {
        updatePortfolio();
    } else if (pageName === 'history') {
        updateHistory();
    }
}

// í™ˆ í™”ë©´ ì—…ë°ì´íŠ¸
function updateHome() {
    // ì´ìì‚° ê³„ì‚°
    totalAsset = 0;
    totalProfit = 0;
    
    portfolio.forEach(stock => {
        const currentValue = stock.quantity * stock.currentPrice;
        const buyValue = stock.quantity * stock.avgPrice;
        totalAsset += currentValue;
        totalProfit += (currentValue - buyValue);
    });
    
    // í™”ë©´ ì—…ë°ì´íŠ¸
    document.getElementById('total-asset').textContent = `â‚©${totalAsset.toLocaleString()}`;
    document.getElementById('profit-amount').textContent = `${totalProfit >= 0 ? '+' : ''}â‚©${Math.abs(totalProfit).toLocaleString()}`;
    
    const profitRate = totalAsset > 0 ? (totalProfit / (totalAsset - totalProfit) * 100).toFixed(2) : 0;
    document.getElementById('profit-rate').textContent = `${totalProfit >= 0 ? '+' : ''}${profitRate}%`;
    
    // ìƒ‰ìƒ ë³€ê²½
    if (totalProfit < 0) {
        document.getElementById('profit-amount').className = 'profit-amount negative';
        document.getElementById('profit-rate').className = 'profit-rate negative';
    }
    
    // AI ì¶”ì²œ ì¹´ë“œ ìƒì„±
    generateAIRecommendations();
}

// AI ì¶”ì²œ ì¹´ë“œ ìƒì„±
function generateAIRecommendations() {
    const container = document.getElementById('ai-recommendations');
    container.innerHTML = '';
    
    // ìƒ˜í”Œ AI ì¶”ì²œ (ì‹¤ì œë¡œëŠ” MCP API í˜¸ì¶œ)
    const recommendations = [
        {
            type: 'danger',
            icon: 'âš ï¸',
            title: 'ì‚¼ì„±ì „ì ë§¤ë„ ì‹œê·¸ë„',
            stock: 'ì‚¼ì„±ì „ì',
            currentPrice: 'â‚©68,500',
            recommendation: 'â‚©68,000 ì´ìƒ',
            reason: 'ë‹¨ê¸° ê³ ì  ë„ë‹¬',
            action: 'ë§¤ë„í•˜ê¸°'
        },
        {
            type: 'opportunity',
            icon: 'ğŸ¯',
            title: 'SKí•˜ì´ë‹‰ìŠ¤ ë§¤ìˆ˜ ì°¬ìŠ¤',
            stock: 'SKí•˜ì´ë‹‰ìŠ¤',
            currentPrice: 'â‚©125,000',
            recommendation: 'â‚©124,000-125,000',
            reason: 'ê³¨ë“ í¬ë¡œìŠ¤ ë°œìƒ',
            action: 'ë§¤ìˆ˜í•˜ê¸°'
        }
    ];
    
    recommendations.forEach(rec => {
        const card = document.createElement('div');
        card.className = `action-card ${rec.type}`;
        card.innerHTML = `
            <div class="action-title">
                ${rec.icon} ${rec.title}
            </div>
            <div class="detail-box">
                <div class="detail-row">
                    <span class="detail-label">í˜„ì¬ê°€</span>
                    <span class="detail-value">${rec.currentPrice}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">ì¶”ì²œê°€</span>
                    <span class="detail-value">${rec.recommendation}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">ê·¼ê±°</span>
                    <span class="detail-value">${rec.reason}</span>
                </div>
            </div>
            <button class="action-button">${rec.action} â†’</button>
        `;
        container.appendChild(card);
    });
    
    // ì¶”ì²œì´ ì—†ìœ¼ë©´ ì•ˆì • ìƒíƒœ
    if (container.children.length === 0) {
        document.getElementById('status-icon').textContent = 'âœ…';
        document.getElementById('status-text').textContent = 'í¬íŠ¸í´ë¦¬ì˜¤ ì•ˆì •';
    } else {
        document.getElementById('status-icon').textContent = 'ğŸ’¡';
        document.getElementById('status-text').textContent = 'AI ì¶”ì²œ í™•ì¸ í•„ìš”';
    }
}

// í¬íŠ¸í´ë¦¬ì˜¤ í™”ë©´ ì—…ë°ì´íŠ¸
function updatePortfolio() {
    const stockList = document.getElementById('stock-list');
    stockList.innerHTML = '';
    
    portfolio.forEach(stock => {
        const value = stock.quantity * stock.currentPrice;
        const profit = (stock.currentPrice - stock.avgPrice) * stock.quantity;
        const profitRate = ((stock.currentPrice - stock.avgPrice) / stock.avgPrice * 100).toFixed(2);
        
        const card = document.createElement('div');
        card.className = 'stock-card';
        card.innerHTML = `
            <div class="stock-header">
                <div>
                    <div class="stock-name">${stock.name}</div>
                    <div class="stock-quantity">${stock.quantity}ì£¼ ë³´ìœ </div>
                </div>
            </div>
            <div class="stock-current">â‚©${stock.currentPrice.toLocaleString()}</div>
            <div class="stock-profit">
                <span>í‰ê°€: â‚©${value.toLocaleString()}</span>
                <span class="${profit >= 0 ? 'positive' : 'negative'}">
                    ${profit >= 0 ? '+' : ''}${profitRate}%
                </span>
            </div>
        `;
        stockList.appendChild(card);
    });
    
    if (portfolio.length === 0) {
        stockList.innerHTML = '<div style="text-align:center;padding:40px;color:#8B95A1">í¬íŠ¸í´ë¦¬ì˜¤ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤<br>ë§¤ìˆ˜ ê¸°ë¡ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”</div>';
    }
}

// ê¸°ë¡ í™”ë©´ ì—…ë°ì´íŠ¸
function updateHistory() {
    const historyList = document.getElementById('history-list');
    historyList.innerHTML = '';
    
    // ëˆ„ì  ìˆ˜ìµ ê³„ì‚°
    let cumulativeProfit = 0;
    history.forEach(record => {
        if (record.type === 'sell') {
            cumulativeProfit += record.profit;
        }
    });
    
    document.getElementById('total-profit').textContent = `${cumulativeProfit >= 0 ? '+' : ''}â‚©${Math.abs(cumulativeProfit).toLocaleString()}`;
    document.getElementById('total-profit').className = `portfolio-value ${cumulativeProfit >= 0 ? 'positive' : 'negative'}`;
    
    // ìµœê·¼ ê±°ë˜ í‘œì‹œ (ìµœì‹ ìˆœ)
    history.slice().reverse().forEach(record => {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `
            <div class="history-date">${record.date}</div>
            <div class="history-detail">
                <div class="history-stock">${record.stock} ${record.type === 'buy' ? 'ë§¤ìˆ˜' : 'ë§¤ë„'}</div>
                <div class="history-profit ${record.profit >= 0 ? 'positive' : 'negative'}">
                    ${record.type === 'sell' ? (record.profit >= 0 ? '+' : '') + 'â‚©' + Math.abs(record.profit).toLocaleString() : 'â‚©' + record.amount.toLocaleString()}
                </div>
            </div>
        `;
        historyList.appendChild(item);
    });
    
    if (history.length === 0) {
        historyList.innerHTML = '<div style="text-align:center;padding:40px;color:#8B95A1">ê±°ë˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    }
}

// ë§¤ìˆ˜ ëª¨ë‹¬
function openBuyModal() {
    document.getElementById('buy-modal').classList.add('show');
}

function closeBuyModal() {
    document.getElementById('buy-modal').classList.remove('show');
    document.getElementById('buy-stock-name').value = '';
    document.getElementById('buy-quantity').value = '';
    document.getElementById('buy-price').value = '';
}

function confirmBuy() {
    const name = document.getElementById('buy-stock-name').value;
    const quantity = parseInt(document.getElementById('buy-quantity').value);
    const price = parseInt(document.getElementById('buy-price').value);
    
    if (!name || !quantity || !price) {
        alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
    }
    
    // í¬íŠ¸í´ë¦¬ì˜¤ì— ì¶”ê°€ ë˜ëŠ” ì—…ë°ì´íŠ¸
    const existingStock = portfolio.find(s => s.name === name);
    if (existingStock) {
        const totalQty = existingStock.quantity + quantity;
        const totalValue = (existingStock.quantity * existingStock.avgPrice) + (quantity * price);
        existingStock.avgPrice = Math.round(totalValue / totalQty);
        existingStock.quantity = totalQty;
    } else {
        portfolio.push({
            name: name,
            quantity: quantity,
            avgPrice: price,
            currentPrice: price
        });
    }
    
    // ê¸°ë¡ì— ì¶”ê°€
    history.push({
        date: new Date().toLocaleDateString('ko-KR'),
        type: 'buy',
        stock: name,
        quantity: quantity,
        price: price,
        amount: quantity * price,
        profit: 0
    });
    
    // ì €ì¥
    localStorage.setItem('portfolio', JSON.stringify(portfolio));
    localStorage.setItem('history', JSON.stringify(history));
    
    closeBuyModal();
    updateHome();
}

// ë§¤ë„ ëª¨ë‹¬
function openSellModal() {
    document.getElementById('sell-modal').classList.add('show');
}

function closeSellModal() {
    document.getElementById('sell-modal').classList.remove('show');
    document.getElementById('sell-stock-name').value = '';
    document.getElementById('sell-quantity').value = '';
    document.getElementById('sell-price').value = '';
}

function confirmSell() {
    const name = document.getElementById('sell-stock-name').value;
    const quantity = parseInt(document.getElementById('sell-quantity').value);
    const price = parseInt(document.getElementById('sell-price').value);
    
    if (!name || !quantity || !price) {
        alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
    }
    
    // í¬íŠ¸í´ë¦¬ì˜¤ì—ì„œ ì°¨ê°
    const existingStock = portfolio.find(s => s.name === name);
    if (!existingStock) {
        alert('ë³´ìœ í•˜ì§€ ì•Šì€ ì¢…ëª©ì…ë‹ˆë‹¤');
        return;
    }
    
    if (existingStock.quantity < quantity) {
        alert('ë³´ìœ  ìˆ˜ëŸ‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤');
        return;
    }
    
    // ìˆ˜ìµ ê³„ì‚°
    const profit = (price - existingStock.avgPrice) * quantity;
    
    // ìˆ˜ëŸ‰ ì°¨ê°
    existingStock.quantity -= quantity;
    if (existingStock.quantity === 0) {
        portfolio = portfolio.filter(s => s.name !== name);
    }
    
    // ê¸°ë¡ì— ì¶”ê°€
    history.push({
        date: new Date().toLocaleDateString('ko-KR'),
        type: 'sell',
        stock: name,
        quantity: quantity,
        price: price,
        amount: quantity * price,
        profit: profit
    });
    
    // ì €ì¥
    localStorage.setItem('portfolio', JSON.stringify(portfolio));
    localStorage.setItem('history', JSON.stringify(history));
    
    closeSellModal();
    updateHome();
}

// ì‹¤ì‹œê°„ ê°€ê²© ì—…ë°ì´íŠ¸ ì‹œë®¬ë ˆì´ì…˜
function updatePrices() {
    portfolio.forEach(stock => {
        // ëœë¤í•˜ê²Œ ê°€ê²© ë³€ë™ (-2% ~ +2%)
        const change = (Math.random() - 0.5) * 0.04;
        stock.currentPrice = Math.round(stock.currentPrice * (1 + change));
    });
    
    localStorage.setItem('portfolio', JSON.stringify(portfolio));
    
    // í˜„ì¬ í˜ì´ì§€ê°€ í™ˆì´ë©´ ì—…ë°ì´íŠ¸
    if (document.getElementById('home').classList.contains('active')) {
        updateHome();
    }
}

// MCP API ì—°ë™ í•¨ìˆ˜ (í–¥í›„ êµ¬í˜„)
async function fetchMCPRecommendations() {
    if (!API_URL) return;
    
    try {
        const response = await fetch(`${API_URL}/api/recommend`);
        const data = await response.json();
        console.log('MCP ì¶”ì²œ:', data);
        // ì‹¤ì œ ì¶”ì²œ ë°ì´í„°ë¡œ AI ì¹´ë“œ ì—…ë°ì´íŠ¸
    } catch (error) {
        console.error('MCP ì—°ê²° ì‹¤íŒ¨:', error);
    }
}

// ì´ˆê¸°í™”
window.onload = function() {
    updateHome();
    
    // 10ì´ˆë§ˆë‹¤ ê°€ê²© ì—…ë°ì´íŠ¸
    setInterval(updatePrices, 10000);
    
    // 30ì´ˆë§ˆë‹¤ AI ì¶”ì²œ ì—…ë°ì´íŠ¸
    setInterval(fetchMCPRecommendations, 30000);
};
</script>

</body>
</html>